@page "/ChangePassword"
@inject AuthenticationHttpClient Http
@inject NavigationManager NavigationManager



<AuthorizeView>
    <Authorized>

        <div class="card">
            <div class="card-header">
                @ApplicationResource.Change_Password
            </div>
            <div class="card-body">
                <EditForm Context="eContext" Model="@changePasswordDTO" OnValidSubmit="@change">
                    <DataAnnotationsValidator />
                    <ValidationSummary />
                    <div class="mb-3">
                        <InputText class="form-control" id="CurrentPassword" @bind-Value="changePasswordDTO.CurrentPassword" placeholder="@ApplicationResource.Current_Password" />
                    </div>

                    <div class="mb-3">
                        <InputText class="form-control" id="NewPassword" @bind-Value="changePasswordDTO.NewPassword" placeholder="@ApplicationResource.New_Password" />
                    </div>

                    <div class="mb-3">
                        <InputText class="form-control" id="ConfirmNewPassword" @bind-Value="changePasswordDTO.ConfirmNewPassword" placeholder="@ApplicationResource.Confirm_New_Password" />
                    </div>
                    @if (!changing)
                    {
                        <button class="btn btn-primary" type="submit">@ApplicationResource.save</button>
                    }
                    else
                    {
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    }
                </EditForm>
            </div>
        </div>
    </Authorized>
    <NotAuthorized>

    </NotAuthorized>
</AuthorizeView>


@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationState { set; get; }
    AuthenticationState user;
    private bool changing;
    public ChangePasswordDTO changePasswordDTO { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        user = await authenticationState;
        if (user != null && user.User.Identity.IsAuthenticated)
        {
            changePasswordDTO.Email = user.User.Identity.Name;
        }
    }
    async void change()
    {
        changing = true;
        var result = await Http.ChangePassword(changePasswordDTO);
        NavigationManager.NavigateTo("/");
        changing = false;

    }
}